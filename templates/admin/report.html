{% extends 'admin/admin_base.html' %}

{% block content%}


<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>

<div id="page-content-wrapper">
  <div class="container-fluid px-4">
    <div class="card">
      <div class="card-title">INCIDENT REPORTS</div>
      <div class="row">
        <div class="col-lg-6 text-end">
        </div>

        <div id="exportByStatusSection" class="input-group input-group-sm ms-3">
          <label class="input-group-text" for="filterByStatus">Export to PDF:</label>
          <select class="form-select" name="filterByStatus" id="filterByStatus">
            <option value="all">ALL REPORTS</option>
            <option value="Pending">PENDING</option>
            <option value="Ongoing">ONGOING</option>
            <option value="Resolved">RESOLVED</option>
            <option value="Fraudulent">FRAUDULENT</option>
          </select>
        </div>

        <div id="filterByStatusSection" class="input-group input-group-sm">
          <label class="input-group-text" for="filterByStatus">Filter:</label>
          <select class="form-select" name="filterByStatus" id="filterByStatus">
            <option value="all">ALL REPORTS</option>
            <option value="Pending">PENDING</option>
            <option value="Ongoing">ONGOING</option>
            <option value="Resolved">RESOLVED</option>
            <option value="Fraudulent">FRAUDULENT</option>
          </select>
        </div>


      </div>
      <div class="row">
        <table id="reportTable" style="width: 100%;">
          <thead>
            <tr>
              <th class="th text-center">Report ID</th>
              <th class="th text-center">Date and Time</th>
              <th class="th text-center">Phone Number</th>
              <th class="th text-center">Name</th>
              <th class="th text-center">Location</th>
              <th class="th text-center">Victims (Estimated)</th>
              <th class="th text-center">Further Details</th>
              <th class="th text-center">Status</th>
              <th class="th text-center">View Details</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports %}
            <tr data-status="{{ report[13 ]}}">
              <td class="text-center">{{ report[0] }}</td>
              <td class="text-center">{{ report[1] }}</td>
              <td class="text-center">{{ report[2] }}</td>
              <td class="text-center">{{ report[3] }}</td>
              <td class="text-center">
                {% if report[5] !=0 and report[6] !=0 %}
                <button type="button" class="btn icon-button show-map-btn" data-toggle="modal"
                  data-lat="{{ report[5] }}" data-lng="{{ report[6] }}">
                  <i class="fas fa-map-marked-alt fa-lg"></i>
                </button>
                {% else %}
                {{ report[4] }}
                {% endif %}
              </td>
              <td class="text-center">{{ report[7] }}</td>
              <td class="text-center">{{ report[8] }}</td>
              <td class="text-center">{{ report[13] }}</td>
              <td class="text-center">
                <button type="button" class="btn icon-button details-btn" data-toggle="modal"
                  data-target="#detailsModal" data-report-id="{{ report[0] }}" data-date="{{ report[1] }}"
                  data-phone="{{ report[2] }}" data-name="{{ report[3] }}" data-location="{{ report[4] }}"
                  data-victims="{{ report[7] }}" data-details="{{ report[8] }}" data-picture="{{ report[9] }}"
                  data-responder="{{ report[10] }}" data-status="{{ report[13] }}" data-category="{{ report[14] }}"
                  data-cluster="{{ report[11]}}" data-distance="{{ report[12]}}">
                  <i class="far fa-file fa-lg"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Map Modal -->
  <div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true"
    data-bs-backdrop="static">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-between">
          <button type="button" class="btn-close btn-lg" data-bs-dismiss="modal" aria-label="Close"
            style="font-size: 1.2rem;">
          </button>
        </div>
        <div class="modal-body" style="text-align: center;">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModal" aria-hidden="true"
  data-bs-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-between">
        <h5 class="modal-title" id="detailsModalLabel">Report Details</h5>
        <button type="button" class="btn-close btn-lg" data-bs-dismiss="modal" aria-label="Close"
          style="font-size: 1.2rem;">
        </button>
      </div>
      <div class="modal-body" style=" overflow-y: auto;">
        <!-- Data will be populated here -->
      </div>
      <div class="modal-footer">
        <!-- Close Button -->
        <button type="button" class="btn btn-primary" id="printReportButton">Print</button>
        <!-- Edit Button -->
        <button type="button" class="btn btn-primary" id="editReport" data-report-id="{{ reportId }}">Edit</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Details Modal -->
<div class="modal fade" id="editDetailsModal" tabindex="-1" role="dialog" aria-labelledby="editDetailsModal"
  aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-center">
        <h5 class="modal-title" id="detailsModalLabel">Report Details</h5>
        <button type="button" class="btn-close btn-lg" data-bs-dismiss="modal" aria-label="Close"
          style="font-size: 1.2rem;">
        </button>
      </div>
      <div class="modal-body" style="font-size: large; overflow-y: auto;">
        <form id="editReportForm" action="/update_report" method="POST">
          <div class="form-group">
            <label for="responder_report" class="form-label">Responder's Report:</label>
            <textarea class="form-control" id="responder_report" name="responder_report" rows="2"
              maxlength="255" required></textarea>
          </div>
          <div class="form-group">
            <label for="category">Category:</label>
            <select class="form-control form-select" id="category" name="category" required style="height: 3vw;">
              <option value="1">Medical Emergency</option>
              <option value="2">Vehicular Accident</option>
              <option value="3">Other Emergency</option>
            </select>
          </div>
          <div class="form-group">
            <label for="status">Status:</label>
            <select class="form-control form-select" id="status" name="status" required style="height: 3vw;">
              <option value="1">Pending</option>
              <option value="2">Ongoing</option>
              <option value="3">Resolved</option>
              <option value="4">Fraudulent</option>
            </select>
          </div>
      </div>
      <div class="modal-footer">
        <!-- Edit Button -->
        <button type="submit" class="btn btn-primary" id="saveReport">Save</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Start of Success Modal -->
<div id="viewSuccessModal" class="modal fade" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true"
  data-bs-backdrop="static">
  <div class="modal-dialog " style="margin: auto;">
    <div class="modal-content modal-content-1 success">
      <!-- Modal Body -->
      <div class="modal-body" style="text-align: center">
        <i class="fa fa-check-circle fa-8x mb-3" style="color: #02ca2a;"></i>
        <h5>Report has been updated.</h5>
      </div>
      <!-- Modal Footer -->
      <div class="modal-footer d-flex justify-content-center align-items-center">
        <!-- Close Button -->
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          OKAY
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
  $(document).ready(function () {
    $('#reportTable').DataTable({
      //"searching": false, // Disable search bar
      //"paging": false, // Disable pagination
      "lengthChange": false, // Disable "entries per page" selection
      "order": [[0, "desc"]], // Order by Report ID in descending order
      //"info" : false,
    });
  });
</script>

<script>
  $(document).ready(function () {
    $(document).on('click', '.show-map-btn', function () {
      $('#mapModal').modal('show');
      var lat = $(this).data('lat');
      var lng = $(this).data('lng');
      $('#mapModal').on('shown.bs.modal', function () {
        initializeMap(lat, lng);
      });
    });

    function initializeMap(lat, lng) {
      // Remove any existing map instance
      $('#map').remove();

      // Create a new map container
      var mapContainer = $('<div id="map" style="width: 100%; height: 100%;"></div>');
      $('.modal-body').append(mapContainer);

      var map = L.map('map').setView([lat, lng], 17);

      map.setMinZoom(14); // Adjust the maximum zoom level as needed

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      const marker = L.marker([lat, lng]).addTo(map);
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var currentReportId; // Variable to store the current reportId

    var detailsButtons = document.querySelectorAll(".details-btn");
    detailsButtons.forEach(function (button) {
      button.addEventListener("click", function () {
        var reportId = this.getAttribute("data-report-id");
        var date = this.getAttribute("data-date");
        var phone = this.getAttribute("data-phone");
        var name = this.getAttribute("data-name");
        var location = this.getAttribute("data-location");
        var victims = this.getAttribute("data-victims");
        var details = this.getAttribute("data-details");
        var status = this.getAttribute("data-status");
        var category = this.getAttribute("data-category");
        var responder = this.getAttribute("data-responder");
        var picture = this.getAttribute("data-picture"); // Get picture URL
        var cluster = this.getAttribute("data-cluster");
        var distance = this.getAttribute("data-distance");

        // Populate modal header and body with data
        var modal = document.querySelector("#detailsModal");
        var modalTitle = modal.querySelector(".modal-title");
        var modalBody = modal.querySelector(".modal-body");

        modalTitle.innerText = "Incident Report No. " + reportId;

        var warningMessage = " ";
        // Display a warning message if the cluster distance is less than 0.75
        if (distance < 0.75) {
          warningMessage = `<p style="color: red; font-weight: bold; margin-bottom: 10px;">**Warning:** This report may be fraudulent or suspicious. Verify report details thoroughly.</p>`;
        }

        modalBody.innerHTML = `
          ${warningMessage}
          <p class="mb-3"><span style="color: gray;">Category:</span> ${category}</p>
          <p class="mb-3"><span style="color: gray;">Date and Time:</span> ${date}</p>
          <p class="mb-3"><span style="color: gray;">Phone Number:</span> ${phone}</p>
          <p class="mb-3"><span style="color: gray;">Reported by:</span> ${name}</p>
          <p class="mb-3"><span style="color: gray;">Location:</span> ${location}</p>
          <p class="mb-3"><span style="color: gray;">Estimated Number of Victims:</span> ${victims}</p>
          <p class="mb-3"><span style="color: gray;">Further Details:</span> ${details}</p>
          <p class="mb-3"><span style="color: gray;">Responder's Report:</span> ${responder ? responder : 'None'}</p>
          ${picture !== 'None' && picture !== null ?  // Check for both null and "None"
            `<p class="mb-3"><span style="color: gray;">Picture:</span><br><img src="${picture}" alt="Incident Picture" style="display: block; margin: 0 auto; max-width: 40%; height: auto;"></p>` :
            '<p class="mb-3"><span style="color: gray;">Picture:</span> No picture available</p>'
          }
        `;

        // Set the title of the editDetailsModal
        var editModalTitle = document.querySelector("#editDetailsModal .modal-title");
        editModalTitle.innerText = "Edit Incident Report No. " + reportId;
        // Add report ID to edit button data attribute
        currentReportId = this.getAttribute("data-report-id");

        // Pre-fill the editDetailsModal form fields with the passed data
        var editResponderReport = document.querySelector("#editDetailsModal #responder_report");
        var editStatus = document.querySelector("#editDetailsModal #status");
        var editCategory = document.querySelector("#editDetailsModal #category");
        if (responder !== 'None') {
          editResponderReport.value = responder;
        } else {
          editResponderReport.value = ''; // or any other default value you prefer
        }

        // Map status string to corresponding value
        var statusValue;
        switch (status.toLowerCase()) {
          case 'pending':
            statusValue = 1;
            break;
          case 'ongoing':
            statusValue = 2;
            break;
          case 'resolved':
            statusValue = 3;
            break;
          case 'fraudulent':
            statusValue = 4;
            break;
          default:
            statusValue = 1; // Default to 'Pending' if status is not recognized
        }

        editStatus.value = statusValue;

        // Map category string to corresponding value
        var categoryValue;
        switch (category.toLowerCase()) {
          case 'medical emergency':
            categoryValue = 1;
            break;
          case 'vehicular accident':
            categoryValue = 2;
            break;
          case 'other emergency':
            categoryValue = 3;
            break;
          default:
            categoryValue = 3; // Default to 'Other Emergency' if category is not recognized
        }
        editCategory.value = categoryValue;

        // Disable "Pending" option if current status is "Ongoing"
        var pendingOption = editStatus.querySelector("option[value='1']");
        if (statusValue === 2) {
          pendingOption.disabled = true;
        } else {
          pendingOption.disabled = false;
        }

        // Disable the edit report button if status is "Resolved" or "Fraudulent"
        var editButton = document.getElementById("editReport");
        if (statusValue === 3 || statusValue === 4) {
          editButton.disabled = true;
        } else {
          editButton.disabled = false;
        }

        // Show the modal
        $('#detailsModal').modal('show');
      });
    });

    // Print button event listener
    document.getElementById("printReportButton").addEventListener("click", function () {
      printIndividualReport(currentReportId);
    });

    // Event listener for edit button click
    var editButton = document.getElementById("editReport");
    editButton.addEventListener("click", function () {
      // Set the reportId attribute of the edit button
      editButton.dataset.reportId = currentReportId;
      // Show the editDetailsModal
      $('#editDetailsModal').modal('show');
    });

    // Event listener for form submission
    document.getElementById("editReportForm").addEventListener("submit", function (event) {
      // Prevent default form submission
      event.preventDefault();

      // Manually submit the form
      var form = this;

      // Retrieve the reportId from the stored variable
      var reportId = currentReportId;

      // Add the reportId to the form data
      var formData = new FormData(form);
      formData.append('reportId', reportId);

      $.ajax({
        url: form.action,
        method: form.method,
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          // Hide the editDetailsModal
          $('#detailsModal').modal('hide');
          $('#editDetailsModal').modal('hide');
          // Show the success modal
          $('#viewSuccessModal').modal('show');
        },
        error: function (xhr, status, error) {
          // Handle error response
          console.error("Error submitting form:", error);
          console.log("Response:", xhr.responseText);
          // Optionally display error message to user
        }
      });
    });

    // Event listener for the OKAY button in the success modal
    $('#viewSuccessModal').on('hidden.bs.modal', function () {
      location.reload();
    });
  });
</script>

<script>
  function printReportPDF() {
    window.location.href = "/report/print-pdf";  // Redirect to the new route
  }
  function printIndividualReport(reportId) {
    fetch(`/report/print-individual/${reportId}`)
      .then(response => response.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `report_${reportId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      })
      .catch(error => console.error('Error:', error));
  }

</script>

<script>
  // Connect to the SocketIO server using window.location.hostname and the specified namespace
  var socket = io.connect('/report');

  socket.on('connect', function () {
    console.log('Connected to server');
  });

  socket.on('new_report', function () {
    console.log('Received report data:');
    window.location.reload()
  });

</script>

<script>
  $(document).ready(function () {
    // Initialize DataTable
    let table = $('#reportTable').DataTable();

    // Retrieve saved filter value from sessionStorage (or localStorage for persistent across sessions)
    let savedStatusFilter = sessionStorage.getItem('statusFilter');
    if (savedStatusFilter) {
      $('#filterByStatus').val(savedStatusFilter); // Set dropdown value
      table.column(7).search(savedStatusFilter === 'all' ? '' : '^' + savedStatusFilter + '$', true, false).draw(); // Apply filter
    }

    // Event listener for the filter dropdown
    $('#filterByStatus').on('change', function () {
      let statusFilter = this.value;

      // Save filter value to sessionStorage
      sessionStorage.setItem('statusFilter', statusFilter);

      // Use the search API to filter by the status
      table.column(7).search(statusFilter === 'all' ? '' : '^' + statusFilter + '$', true, false).draw();
    });
  });
</script>


{% endblock %}