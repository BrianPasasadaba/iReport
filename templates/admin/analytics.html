{% extends 'admin/admin_base.html' %} {% block content%}
<div id="page-content-wrapper">
  <div class="container-fluid px-4">
    <div class="card">
      <div class="card-title">ANALYTICS</div>
      <div id="analytics-1" class="card analytics-card">
        <div class="row">
          <div class="col-xl-8 d-flex justify-content-center card-title">
            INCIDENTS FOR THE MONTH OF
          </div>
          <div class="dropdown col-xl-4 d-flex justify-content-start">
            <select
              id="month-dropdown"
              class="form-select"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <option value="" selected>All Months</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-3 col-md-4 mt-3 d-flex justify-content-start">
            <div class="legend-container">
              <span class="legend-circle medical"></span>
              <span class="legend-text">Medical Emergency</span>
            </div>
          </div>

          <div class="col-lg-3 col-md-4 mt-3 d-flex justify-content-start">
            <div class="legend-container">
              <span class="legend-circle vehicular"></span>
              <span class="legend-text">Vehicular Accident</span>
            </div>
          </div>

          <div class="col-lg-3 col-md-4 mt-3 d-flex justify-content-start">
            <div class="legend-container">
              <span class="legend-circle other"></span>
              <span class="legend-text">Other Emergencies</span>
            </div>
          </div>

          <div class="col-lg-2 mt-3 d-flex justify-content-start">
            <div class="analytic-year">
              <label for="year">YEAR</label>
            </div>
            <select id="year-dropdown" class="form-select">
              <option value="2024" selected>2024</option>
              <option value="2025">2025</option>
            </select>
          </div>
        </div>
        <div style="height: 55vh">
          <canvas id="barChart" class="mt-3"></canvas>
        </div>
      </div>
      <div id="analytics-2" class="card">
        <div class="card-title">INCIDENTS PER BARANGAY</div>
        <div class="row">
          <div class="col-lg-3 col-md-4 col-xs-6">
            <div class="legend-container mb-3">
              <span class="legend-circle medical"></span>
              <span class="legend-text">Medical Emergency</span>
            </div>
            <div class="legend-container mb-3">
              <span class="legend-circle vehicular"></span>
              <span class="legend-text">Vehicular Accident</span>
            </div>
            <div class="legend-container mb-3">
              <span class="legend-circle other"></span>
              <span class="legend-text">Other Emergencies</span>
            </div>
          </div>
          <div class="col-lg-9 col-md-8 col-xs-6">
            <div id="map" style="height: 55vh"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block script %}

<script>
  // Function to update chart based on selected month and year
  function updateChart(month, year) {
    fetch(`/analytics/data?month=${month}&year=${year}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        // Assuming data is returned as { labels: [...], values: [...] }
        chart.data.labels = data.labels;
        chart.data.datasets[0].data = data.values;
        chart.update();
      })
      .catch((error) => {
        console.error("Error updating chart:", error);
      });
  }

  var ctx = document.getElementById("barChart").getContext("2d");
  var chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [
        {
          label: "Count of Incidents",
          backgroundColor: [
            "rgba(169, 18, 18, 0.7)", // Red
            "rgba(16, 10, 81, 0.7)", // Blue
            "rgba(40, 40, 40, 0.7)", // Dark Gray
          ],
          borderColor: [
            "rgba(255, 99, 132, 1)", // Red
            "rgba(54, 162, 235, 1)", // Blue
            "rgba(73, 73, 73, 1)", // Dark Gray
          ],
          borderWidth: 1,
          data: [],
        },
      ],
    },
    options: {
      plugins: {
        legend: {
          display: false,
        },
      },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          min: 0,
          ticks: {
            // forces step size to be 50 units
            stepSize: 1,
          },
        },
      },
    },
  });

  // Assuming you have month and year dropdowns with IDs 'month-dropdown' and 'year-dropdown'
  const monthDropdown = document.getElementById("month-dropdown");
  const yearDropdown = document.getElementById("year-dropdown");

  // Add event listeners to dropdowns
  monthDropdown.addEventListener("change", function () {
    const selectedMonth = monthDropdown.value;
    const selectedYear = yearDropdown.value;
    updateChart(selectedMonth, selectedYear);
  });

  yearDropdown.addEventListener("change", function () {
    const selectedMonth = monthDropdown.value;
    const selectedYear = yearDropdown.value;
    updateChart(selectedMonth, selectedYear);
  });

  // Initial call to update chart based on initial selected values
  const initialMonth = monthDropdown.value;
  const initialYear = yearDropdown.value;
  updateChart(initialMonth, initialYear);
</script>

<script>
  var map = L.map('map');

  // Add the OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // Coordinates passed from Flask app
  var coordinates = {{ coordinates | tojson }};

  // Set initial map view (replace with your desired zoom level)
  map.setView([14.247142, 121.136673], 12); // Adjust zoom level as needed

  map.setMinZoom(12); // Adjust the maximum zoom level as needed

  // Define marker icons
  var redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  var blueIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  var blackIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });


  // Iterate through each coordinate and add a marker with appropriate icon
  coordinates.forEach(function (coord) {
    var markerIcon;
    switch (coord.category_id) {
      case 1:
        markerIcon = redIcon;
        break;
      case 2:
        markerIcon = blueIcon;
        break;
      case 3:
        markerIcon = blackIcon;
        break;
      default:
        markerIcon = redIcon; // Default to red if category_id doesn't match
        break;
    }

    var marker = L.marker([coord.lat, coord.lng], { icon: markerIcon }).addTo(map);
  });
</script>

{% endblock %}
